<script>
    // --- COMPONENTS ---

    const GlobalNotification = {
        template: '#global-notification-template',
        data() {
            return {
                visible: false,
                title: '',
                message: '',
                type: 'success'
            };
        },
        computed: {
            iconClass() {
                if (this.type === 'success') return 'fa-check-circle';
                if (this.type === 'error') return 'fa-times-circle';
                return 'fa-info-circle';
            }
        },
        methods: {
            show(message, type = 'success', title) {
                this.message = message;
                this.type = type;
                this.title = title || (type === 'success' ? 'Éxito' : 'Error');
                this.visible = true;
            },
            close() {
                this.visible = false;
            }
        }
    };

    const ConfirmationModal = {
        template: '#confirmation-modal-template',
        data() {
            return {
                visible: false,
                title: '',
                message: '',
                confirmText: 'Confirmar',
                cancelText: 'Cancelar',
                onConfirm: null,
                onCancel: null
            };
        },
        methods: {
            show(options) {
                this.title = options.title || '¿Estás seguro?';
                this.message = options.message || '';
                this.confirmText = options.confirmText || 'Confirmar';
                this.cancelText = options.cancelText || 'Cancelar';
                this.onConfirm = options.onConfirm || null;
                this.onCancel = options.onCancel || null;
                this.visible = true;
            },
            confirm() {
                this.visible = false;
                if (this.onConfirm) this.onConfirm();
            },
            cancel() {
                this.visible = false;
                if (this.onCancel) this.onCancel();
            }
        }
    };

    const LoginView = {
        template: '#login-view-template',
        data() {
            return {
                form: {
                    username: '',
                    password: ''
                },
                loading: false,
                error: ''
            };
        },
        methods: {
            handleLogin() {
                this.error = '';

                if (!this.form.username || !this.form.password) {
                    this.error = 'Por favor, completa todos los campos';
                    return;
                }

                this.loading = true;
                console.log('Intentando login con:', this.form.username);

                google.script.run
                    .withSuccessHandler(res => {
                        console.log('Respuesta recibida:', res);
                        console.log('Tipo de respuesta:', typeof res);
                        console.log('Es null?:', res === null);

                        this.loading = false;

                        if (res === null) {
                            this.error = 'Error: El servidor devolvió null. Verifica los logs de Apps Script.';
                            return;
                        }

                        if (res.success) {
                            console.log('Login exitoso, emitiendo evento con usuario:', res.user);
                            this.$emit('login-success', res.user);
                        } else {
                            this.error = res.error;
                        }
                    })
                    .withFailureHandler(err => {
                        console.log('Error de conexión:', err);
                        this.loading = false;
                        this.error = 'Error de conexión: ' + err.message;
                    })
                    .loginUser(this.form.username, this.form.password);
            }
        }
    };

    const TablesView = {
        template: '#tables-view-template',
        props: ['tables']
    };


    const OrdersView = {
        template: '#orders-view-template',
        data() {
            return {
                activeTab: 'active',
                activeOrders: [],
                paidOrders: [],
                loading: false
            };
        },
        computed: {
            tables() {
                return this.$root.tables;
            }
        },
        methods: {
            switchTab(tab) {
                this.activeTab = tab;
                if (tab === 'active' && this.activeOrders.length === 0) {
                    this.loadActiveOrders();
                } else if (tab === 'history' && this.paidOrders.length === 0) {
                    this.loadPaidOrders();
                }
            },
            loadActiveOrders() {
                this.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.loading = false;
                        if (res.success) {
                            this.activeOrders = res.orders;
                        } else {
                            this.$root.showNotification('Error cargando órdenes: ' + res.error, 'error');
                        }
                    })
                    .withFailureHandler(err => {
                        this.loading = false;
                        this.$root.showNotification('Error de conexión: ' + err.message, 'error');
                    })
                    .getActiveOrdersData();
            },
            loadPaidOrders() {
                this.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.loading = false;
                        if (res.success) {
                            this.paidOrders = res.orders;
                        } else {
                            this.$root.showNotification('Error cargando historial: ' + res.error, 'error');
                        }
                    })
                    .withFailureHandler(err => {
                        this.loading = false;
                        this.$root.showNotification('Error de conexión: ' + err.message, 'error');
                    })
                    .getPaidOrdersHistory();
            },
            getTableName(tableId) {
                const table = this.tables.find(t => t.table_id === tableId);
                return table ? table.name : tableId;
            },
            formatTime(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                return date.toLocaleTimeString('es-PE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },
            goToPayment(order) {
                // Preparar datos de la orden para el pago
                const orderData = {
                    cart: order.items,
                    cartTotal: order.total
                };
                // Establecer la orden actual y el ID
                this.$root.currentOrderId = order.order_id;
                this.$root.currentTable = { table_id: order.table_number };
                // Navegar a la vista de pago
                this.$root.goToPaymentView(orderData);
            }
        },
        mounted() {
            // Cargar órdenes activas por defecto (caché en memoria)
            this.loadActiveOrders();
        }
    };

    const CashierView = {
        template: '#cashier-view-template',
        props: ['session'],
        data() {
            return {
                form: {
                    initialAmount: null,
                    countedCash: null,
                    notes: '',
                    cashFlowAmount: null,
                    cashFlowDescription: ''
                },
                activeTab: 'movements',
                // Separate state for each tab
                movements: {
                    list: [],
                    loading: false,
                    totalIncome: 0,
                    totalExpenses: 0,
                    net: 0
                },
                summary: {
                    data: null,
                    loading: false
                },
                closing: {
                    summary: null,
                    loading: false
                }
            };
        },
        computed: {
            difference() {
                if (this.form.countedCash === null || !this.closing.summary) return 0;
                return this.form.countedCash - this.closing.summary.expectedCash;
            }
        },
        methods: {
            switchTab(tabName) {
                this.activeTab = tabName;
                if (tabName === 'movements') {
                    this.loadMovements();
                } else if (tabName === 'summary') {
                    this.loadSummary();
                } else if (tabName === 'close') {
                    this.loadClosingSummary();
                }
            },
            loadMovements() {
                console.log('loadMovements: Starting...');
                this.movements.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        console.log('loadMovements: Response received', res);
                        this.movements.loading = false;

                        // Handle null response
                        if (res === null) {
                            console.error('loadMovements: Received null response - function may not exist in Apps Script');
                            this.$root.showNotification('Error: La función getExpectedCash() no está disponible. Verifica que el código esté desplegado correctamente.', 'error');
                            return;
                        }

                        if (res.success) {
                            console.log('loadMovements: Success, cashFlowTransactions:', res.summary.cashFlowTransactions);
                            this.movements.list = res.summary.cashFlowTransactions || [];
                            this.movements.totalIncome = res.summary.totalIncome || 0;
                            this.movements.totalExpenses = res.summary.totalExpenses || 0;
                            this.movements.net = this.movements.totalIncome - this.movements.totalExpenses;
                            console.log('loadMovements: Movements loaded:', this.movements.list.length);
                        } else {
                            console.error('loadMovements: Error in response:', res.error);
                            this.$root.showNotification('Error cargando movimientos: ' + res.error, 'error');
                        }
                    })
                    .withFailureHandler(err => {
                        console.error('loadMovements: Failure handler called:', err);
                        this.movements.loading = false;
                        this.$root.showNotification('Error de conexión: ' + err.message, 'error');
                    })
                    .getExpectedCash();
            },
            loadSummary() {
                console.log('loadSummary: Starting...');
                this.summary.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        console.log('loadSummary: Response received', res);
                        this.summary.loading = false;

                        if (res === null) {
                            console.error('loadSummary: Received null response');
                            this.$root.showNotification('Error: La función getExpectedCash() no está disponible.', 'error');
                            return;
                        }

                        if (res.success) {
                            this.summary.data = res.summary;
                            console.log('loadSummary: Summary loaded');
                        } else {
                            console.error('loadSummary: Error in response:', res.error);
                            this.$root.showNotification('Error cargando resumen: ' + res.error, 'error');
                        }
                    })
                    .withFailureHandler(err => {
                        console.error('loadSummary: Failure handler called:', err);
                        this.summary.loading = false;
                        this.$root.showNotification('Error de conexión: ' + err.message, 'error');
                    })
                    .getExpectedCash();
            },
            loadClosingSummary() {
                console.log('loadClosingSummary: Starting...');
                this.closing.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        console.log('loadClosingSummary: Response received', res);
                        this.closing.loading = false;

                        if (res === null) {
                            console.error('loadClosingSummary: Received null response');
                            this.$root.showNotification('Error: La función getExpectedCash() no está disponible.', 'error');
                            return;
                        }

                        if (res.success) {
                            this.closing.summary = res.summary;
                            console.log('loadClosingSummary: Summary loaded');
                        } else {
                            console.error('loadClosingSummary: Error in response:', res.error);
                            this.$root.showNotification('Error calculando resumen: ' + res.error, 'error');
                        }
                    })
                    .withFailureHandler(err => {
                        console.error('loadClosingSummary: Failure handler called:', err);
                        this.closing.loading = false;
                        this.$root.showNotification('Error de conexión: ' + err.message, 'error');
                    })
                    .getExpectedCash();
            }
        },
        watch: {
            session(newSession) {
                if (newSession) {
                    this.activeTab = 'movements';
                    this.form.initialAmount = null;
                    this.form.cashFlowAmount = null;
                    this.form.cashFlowDescription = '';
                    this.form.countedCash = null;
                    this.form.notes = '';
                    // Reset all tab states
                    this.movements = { list: [], loading: false, totalIncome: 0, totalExpenses: 0, net: 0 };
                    this.summary = { data: null, loading: false };
                    this.closing = { summary: null, loading: false };
                    // Load initial data
                    this.loadMovements();
                }
            }
        },
        mounted() {
            if (this.session) {
                this.loadMovements();
            }
        }
    };

    const PosView = {
        template: '#pos-view-template',
        props: ['table'],
        data() {
            return {
                showProductModal: false,
                selectedProduct: null,
                selectedModifiers: {},
                cart: [],
                selectedCategory: null
            };
        },
        computed: {
            root() { return this.$root; },
            categories() {
                const allCategories = this.root.products.map(p => p.category);
                return [...new Set(allCategories)];
            },
            filteredProducts() {
                if (!this.selectedCategory) return [];
                return this.root.products.filter(p => p.category === this.selectedCategory);
            },
            availableModifiers() {
                if (!this.selectedProduct || !this.selectedProduct.applicable_modifier_groups) return {};
                const allowedGroups = this.selectedProduct.applicable_modifier_groups.split(',').map(g => g.trim());
                if (allowedGroups.length === 0) return {};
                const groups = {};
                this.root.modifiers.forEach(m => {
                    if (allowedGroups.includes(m.group_name)) {
                        if (!groups[m.group_name]) {
                            groups[m.group_name] = {
                                items: [],
                                selection_mode: m.selection_mode,
                                selection_limit: Number(m.selection_limit || 0)
                            };
                        }
                        groups[m.group_name].items.push(m);
                    }
                });
                return groups;
            },
            cartTotal() {
                return this.cart.reduce((sum, item) => sum + (item.final_price * item.quantity), 0);
            },
            isConfirmDisabled() {
                for (const name in this.availableModifiers) {
                    const group = this.availableModifiers[name];
                    if (group.selection_mode === 'multiple_limited') {
                        const selection = this.selectedModifiers[name];
                        if (!selection || selection.length !== group.selection_limit) return true;
                    }
                }
                return false;
            }
        },
        methods: {
            selectCategory(category) { this.selectedCategory = category; },
            selectProduct(product) {
                const hasModifiers = product.applicable_modifier_groups && product.applicable_modifier_groups.length > 0;
                if (!hasModifiers) {
                    this.addItemToCart({
                        product_id: product.id, product_name: product.name, modifiers_detail: '', modifier_ids: '',
                        quantity: 1, original_price: product.base_price, final_price: product.base_price, notes: ''
                    });
                } else {
                    this.selectedProduct = product;
                    this.selectedModifiers = {};
                    this.$nextTick(() => {
                        for (const name in this.availableModifiers) {
                            const group = this.availableModifiers[name];
                            if (group.selection_mode !== 'single') {
                                this.$set(this.selectedModifiers, name, []);
                            }
                        }
                    });
                    this.showProductModal = true;
                }
            },
            isModifierDisabled(groupName, modifier) {
                const group = this.availableModifiers[groupName];
                if (group.selection_mode !== 'multiple_limited') return false;
                const selection = this.selectedModifiers[groupName];
                if (!selection) return false;
                const limit = group.selection_limit;
                const isSelected = selection.some(m => m.id === modifier.id);
                return selection.length >= limit && !isSelected;
            },
            closeProductModal() {
                this.showProductModal = false;
                this.selectedProduct = null;
                this.selectedModifiers = {};
            },
            confirmAdd() {
                let price = Number(this.selectedProduct.base_price);
                let modifiersDesc = [];
                let modifierIds = [];
                for (const [group, selection] of Object.entries(this.selectedModifiers)) {
                    if (Array.isArray(selection)) {
                        selection.forEach(m => {
                            price += Number(m.price_adjustment);
                            modifiersDesc.push(m.name);
                            modifierIds.push(m.id);
                        });
                    } else if (selection) {
                        price += Number(selection.price_adjustment);
                        modifiersDesc.push(selection.name);
                        modifierIds.push(selection.id);
                    }
                }
                const item = {
                    product_id: this.selectedProduct.id, product_name: this.selectedProduct.name,
                    modifiers_detail: modifiersDesc.sort().join(', '),
                    modifier_ids: modifierIds.sort().join(','),
                    quantity: 1, original_price: price, final_price: price, notes: ''
                };
                this.addItemToCart(item);
                this.closeProductModal();
            },
            addItemToCart(newItem) {
                const existingItemIndex = this.cart.findIndex(cartItem =>
                    cartItem.product_id === newItem.product_id &&
                    cartItem.modifier_ids === (newItem.modifier_ids || '')
                );
                if (existingItemIndex > -1) {
                    this.cart[existingItemIndex].quantity++;
                } else {
                    newItem.item_id = 'ITEM-' + Date.now();
                    this.cart.push(newItem);
                }
            },
            removeFromCart(index) { this.cart.splice(index, 1); },
            increaseQuantity(index) { this.cart[index].quantity++; },
            decreaseQuantity(index) {
                this.cart[index].quantity--;
                if (this.cart[index].quantity <= 0) this.removeFromCart(index);
            },
            saveOrder() {
                if (!this.table) return;
                this.root.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.root.loading = false;
                        if (res.success) {
                            this.$root.showNotification('¡Cambios guardados!', 'success');
                            this.cart.splice(0, this.cart.length, ...res.items); // Force reactivity
                        } else {
                            this.$root.showNotification('Error guardando la orden: ' + res.error, 'error');
                        }
                    })
                    .saveOrderItems(this.root.currentOrderId, this.cart);
            },
            handleFreeUpTable() {
                if (this.cart.length > 0) {
                    this.$root.showNotification('Esta mesa tiene un pedido activo. Por favor, cóbralo o vacía el carrito para poder liberarla.', 'error', 'Acción no permitida');
                    return;
                }
                this.$root.$refs.confirmationModal.show({
                    title: 'Liberar Mesa',
                    message: '¿Estás seguro de que quieres liberar esta mesa? Se eliminará la orden vacía.',
                    confirmText: 'Sí, liberar',
                    cancelText: 'Cancelar',
                    onConfirm: () => {
                        this.root.loading = true;
                        google.script.run
                            .withSuccessHandler(res => {
                                this.root.loading = false;
                                if (res.success) {
                                    this.$root.showNotification('Mesa liberada.', 'success');
                                    this.root.setView('tables');
                                } else {
                                    this.$root.showNotification('Error al liberar la mesa: ' + res.error, 'error');
                                }
                            })
                            .forceFreeUpTable(this.table.table_id, this.root.currentOrderId);
                    }
                });
            }
        },
        mounted() {
            if (this.categories.length > 0) this.selectCategory(this.categories[0]);
        },
        watch: {
            table: {
                handler(newTable) {
                    if (newTable && this.categories.length > 0) this.selectCategory(this.categories[0]);
                },
                immediate: true
            },
            categories: {
                handler(newCategories) {
                    if (this.table && newCategories.length > 0 && (!this.selectedCategory || !newCategories.includes(this.selectedCategory))) {
                        this.selectCategory(newCategories[0]);
                    }
                }
            }
        }
    };

    const EditItemModal = {
        template: '#edit-item-modal',
        props: ['item'],
        data() {
            return { editForm: { final_price: 0, notes: '' } };
        },
        mounted() {
            this.editForm.final_price = this.item.final_price;
            this.editForm.notes = this.item.notes;
        },
        methods: {
            saveEdit() { this.$emit('save', this.editForm); }
        }
    };

    const PaymentView = {
        template: '#payment-view-template-v2',
        props: ['order', 'paymentMethods'],
        data() { return { paymentLines: [] }; },
        computed: {
            totalPaid() { return this.paymentLines.reduce((sum, line) => sum + Number(line.amount || 0), 0); },
            remainingBalance() { return this.order.cartTotal - this.totalPaid; }
        },
        methods: {
            initPaymentLines() { this.paymentLines = [{ payment_method: 'Efectivo', amount: this.order.cartTotal }]; },
            addPaymentLine() {
                const remaining = this.remainingBalance;
                this.paymentLines.push({ payment_method: '', amount: remaining > 0 ? remaining.toFixed(2) : 0 });
            },
            removePaymentLine(index) { this.paymentLines.splice(index, 1); },
            submit() {
                if (Math.abs(this.totalPaid - this.order.cartTotal) > 0.01) {
                    this.$root.showNotification('El monto pagado no coincide con el total de la orden.', 'error');
                    return;
                }
                this.$emit('submit-payment', {
                    payments: this.paymentLines,
                    totalAmount: this.order.cartTotal
                });
            },
            // Add a check to ensure order exists
            validateOrder() {
                if (!this.order || typeof this.order.cartTotal === 'undefined') {
                    console.error('PaymentView: Order is missing or invalid', this.order);
                    this.$root.showNotification('Error: Datos de orden inválidos', 'error');
                    this.$emit('back');
                }
            }
        },
        mounted() {
            this.validateOrder();
            if (this.order) this.initPaymentLines();
        }
    };

    // --- ROOT VUE INSTANCE ---
    new Vue({
        el: '#app',
        components: {
            'tables-view': TablesView,
            'pos-view': PosView,
            'orders-view': OrdersView,
            'cashier-view': CashierView,
            'edit-item-modal': EditItemModal,
            'payment-view': PaymentView,
            'global-notification': GlobalNotification,
            'confirmation-modal': ConfirmationModal,
            'login-view': LoginView
        },
        data: {
            loading: true,
            currentView: 'login',
            currentUser: null,
            products: [],
            modifiers: [],
            tables: [],
            paymentMethods: [],
            currentTable: null,
            currentOrderId: null,
            activeSession: null,
            showEditModal: false,
            editingItem: null,
            editingItemIndex: -1,
            closingSummary: null,
            orderToPay: null
        },
        methods: {
            showNotification(message, type, title) {
                this.$refs.notification.show(message, type, title);
            },
            handleLoginSuccess(user) {
                this.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));

                // Show welcome notification with profile icon
                const welcomeMessage = `¡Bienvenido/a, ${user.full_name}!`;
                this.$refs.notification.show('Inicio de Sesión Exitoso', welcomeMessage, 'success');

                // Check if there's an active cashier session
                if (this.activeSession) {
                    this.loadData();
                    this.setView('tables');
                } else {
                    this.$refs.notification.show(
                        'Atención',
                        'No hay una sesión de caja activa. Puedes abrir una desde el módulo de Caja.',
                        'info'
                    );
                    // Still allow access to tables view
                    this.loadData();
                    this.setView('tables');
                }
            },
            handleLogout() {
                this.currentUser = null;
                this.activeSession = null;
                this.tables = [];
                this.products = [];
                this.modifiers = [];
                this.paymentMethods = [];
                this.currentTable = null;
                this.currentOrderId = null;
                localStorage.removeItem('currentUser');
                this.setView('login');
                this.showNotification('Sesión cerrada correctamente', 'success');
            },
            hasPermission(action) {
                if (!this.currentUser) return false;

                const permissions = {
                    'Administrador': ['all'],
                    'Atención': [
                        'view_tables',
                        'create_order',
                        'edit_order',
                        'view_orders',
                        'process_payment',
                        'open_cashier',
                        'close_cashier',
                        'view_cashier',
                        'add_cash_flow'
                    ]
                };

                const userPermissions = permissions[this.currentUser.role] || [];
                return userPermissions.includes('all') || userPermissions.includes(action);
            },
            checkSession() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    return true;
                }
                return false;
            },
            loadData() {
                this.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.loading = false;
                        if (res.success) {
                            this.products = res.products; this.modifiers = res.modifiers;
                            this.tables = res.tables; this.activeSession = res.activeSession;
                            this.paymentMethods = res.paymentMethods;
                        } else { this.showNotification('Error cargando datos iniciales: ' + res.error, 'error'); }
                    })
                    .withFailureHandler(err => {
                        this.loading = false;
                        this.showNotification('Error de conexión con el servidor. Por favor, recarga la página. ' + err.message, 'error', 'Error de Conexión');
                    })
                    .getInitialData();
            },
            setView(view) {
                if (this.currentView === 'pos' && view !== 'pos' && view !== 'payment') {
                    this.currentTable = null; this.currentOrderId = null;
                }
                this.currentView = view;
            },
            selectTable(table) {
                this.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.loading = false;
                        if (res.success) {
                            this.currentTable = table; this.currentOrderId = res.orderId;
                            this.setView('pos');
                            this.$nextTick(() => {
                                if (this.$refs.viewComponent) this.$refs.viewComponent.cart = res.items || [];
                            });
                        } else { this.showNotification('Error al obtener o crear la orden: ' + res.error, 'error'); }
                    })
                    .getOrCreateTableOrder(table.table_id);
            },
            goToPaymentView(orderData) {
                this.orderToPay = orderData;
                this.setView('payment');
            },
            handleFinalizePayment(paymentData) {
                this.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.loading = false;
                        if (res.success) {
                            this.showNotification('¡Pago registrado y orden cerrada!', 'success');
                            this.orderToPay = null;
                            const tableId = this.currentTable.table_id;
                            const tableIndex = this.tables.findIndex(t => t.table_id === tableId);
                            if (tableIndex > -1) this.tables[tableIndex].status = 'Available';
                            this.setView('tables');
                        } else { this.showNotification('Error procesando el pago: ' + res.error, 'error'); }
                    })
                    .finalizeOrderAndPay(this.currentOrderId, paymentData.payments, paymentData.totalAmount);
            },
            openEditModal({ item, index }) {
                this.editingItem = item; this.editingItemIndex = index;
                this.showEditModal = true;
            },
            saveEditItem(formData) {
                const cart = this.$refs.viewComponent.cart;
                if (cart && cart[this.editingItemIndex]) {
                    Object.assign(cart[this.editingItemIndex], formData);
                }
                this.showEditModal = false;
            },
            fetchExpectedCash() {
                this.closingSummary = null;
                google.script.run
                    .withSuccessHandler(res => {
                        if (res.success) {
                            this.closingSummary = res.summary;
                        } else {
                            this.showNotification('Error obteniendo resumen de caja: ' + res.error, 'error');
                        }
                    })
                    .getExpectedCash();
            },
            handleOpenSession(form) {
                this.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.loading = false;
                        if (res.success) {
                            this.activeSession = res.session;
                            this.showNotification('Caja abierta correctamente', 'success');
                            this.loadData(); // Reload data to update UI
                        } else {
                            this.showNotification('Error al abrir caja: ' + res.error, 'error');
                        }
                    })
                    .withFailureHandler(err => {
                        this.loading = false;
                        this.showNotification('Error de conexión: ' + err.message, 'error');
                    })
                    .startNewCashierSession(form.initialAmount);
            },
            handleCloseSession(data) {
                this.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.loading = false;
                        if (res.success) {
                            this.activeSession = null; // Session closed
                            this.showNotification('Caja cerrada correctamente', 'success');
                            this.loadData();
                            this.setView('login'); // Redirect to login or stay in cashier? Usually logout or reset.
                        } else {
                            this.showNotification('Error al cerrar caja: ' + res.error, 'error');
                        }
                    })
                    .withFailureHandler(err => {
                        this.loading = false;
                        this.showNotification('Error de conexión: ' + err.message, 'error');
                    })
                    .closeCurrentCashierSession(data.countedCash, data.notes);
            },
            handleAddIncome(form) {
                this.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.loading = false;
                        if (res.success) {
                            this.showNotification('Ingreso registrado', 'success');
                            // Refresh movements in CashierView
                            if (this.$refs.cashierView) {
                                this.$refs.cashierView.loadMovements();
                                // Clear form
                                form.cashFlowAmount = null;
                                form.cashFlowDescription = '';
                            }
                        } else {
                            this.showNotification('Error al registrar ingreso: ' + res.error, 'error');
                        }
                    })
                    .withFailureHandler(err => {
                        this.loading = false;
                        this.showNotification('Error de conexión: ' + err.message, 'error');
                    })
                    .addCashFlowTransaction('Ingreso', form.cashFlowAmount, form.cashFlowDescription);
            },
            handleAddExpense(form) {
                this.loading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        this.loading = false;
                        if (res.success) {
                            this.showNotification('Salida registrada', 'success');
                            // Refresh movements in CashierView
                            if (this.$refs.cashierView) {
                                this.$refs.cashierView.loadMovements();
                                // Clear form
                                form.cashFlowAmount = null;
                                form.cashFlowDescription = '';
                            }
                        } else {
                            this.showNotification('Error al registrar salida: ' + res.error, 'error');
                        }
                    })
                    .withFailureHandler(err => {
                        this.loading = false;
                        this.showNotification('Error de conexión: ' + err.message, 'error');
                    })
                    .addCashFlowTransaction('Salida', form.cashFlowAmount, form.cashFlowDescription);
            }
        },
        mounted() {
            this.checkSession();
            this.loadData();
        }
    });
</script>